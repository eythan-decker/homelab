apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: gitops-cert-manager-expiration-loki
  namespace: monitoring
  labels:
    prometheus: kube-prometheus-stack-prometheus
    role: alert-rules
    loki: "true"
spec:
  groups:
    - name: gitops-cert-manager.expiration-logs
      interval: 1m
      rules:
        - alert: GitOpsCertManagerExpirationLogs
          expr: |
            sum(count_over_time({namespace="cert-manager"} |~ "(?i)(expire|expiring)" [5m])) > 3
          for: 5m
          labels:
            severity: warning
            component: cert-manager
          annotations:
            summary: "Cert Manager certificate expiration warnings detected"
            description: "Cert Manager has logged {{ $value }} certificate expiration-related messages in the last 5 minutes. Certificate for homelab may be expiring. Review Cert Manager logs."
            explore_url: "https://grafana.moria-lab.com/explore?schemaVersion=1&panes=%7B%22md9%22:%7B%22datasource%22:%22eeohbrg94r30ga%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22expr%22:%22%7Bnamespace%3D%5C%22cert-manager%5C%22%7D%20%7C%7E%20%5C%22(%3Fi)(expire%7Cexpiring)%5C%22%22,%22queryType%22:%22range%22,%22datasource%22:%7B%22type%22:%22loki%22,%22uid%22:%22eeohbrg94r30ga%22%7D,%22editorMode%22:%22code%22,%22direction%22:%22backward%22%7D%5D,%22range%22:%7B%22from%22:%22now-1h%22,%22to%22:%22now%22%7D%7D%7D&orgId=1"
